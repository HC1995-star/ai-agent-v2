<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradedoubler Onboarding Assistant</title>

  <!-- Brand font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Instrument Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .chat-message {
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .pulse-loader {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.4; }
    }
  </style>
</head>

<body class="bg-white text-gray-900">
  <div class="flex min-h-screen">
    <!-- Sidebar (sticky) -->
    <aside class="w-80 bg-white border-r border-gray-200 p-5 flex flex-col sticky top-0 h-screen overflow-y-auto">
      <div class="flex items-center justify-between mb-5">
        <div>
          <h1 class="text-xl font-semibold text-[#2A73FF]">Tradedoubler</h1>
          <p class="text-xs text-gray-500">AI Onboarding Assistant</p>
        </div>
      </div>

      <!-- Steps nav -->
      <div class="mb-5">
        <h2 class="text-xs font-semibold text-gray-500 mb-2">
          Onboarding steps
        </h2>
        <nav id="steps-nav" class="space-y-1 text-sm">
          <button
            data-step="intro"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>1. Introduction</span>
          </button>
          <button
            data-step="branded"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>2. Branded Tracking</span>
          </button>
          <button
            data-step="feed"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>3. Product Feed</span>
          </button>
          <button
            data-step="assets"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>4. Program Assets (Upload)</span>
          </button>
          <button
            data-step="ip"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>5. IP Addresses</span>
          </button>
          <button
            data-step="scripts"
            class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100"
          >
            <span>6. Tracking Scripts</span>
          </button>
        </nav>
      </div>

      <!-- Progress -->
      <div class="mb-5">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-medium text-gray-600">Overall Progress</span>
          <span id="progress-percentage" class="text-xs font-semibold text-[#2A73FF]">0%</span>
        </div>
        <div class="w-full h-1.5 rounded-full bg-gray-200 overflow-hidden">
          <div
            id="progress-bar"
            class="h-1.5 rounded-full bg-[#2A73FF] transition-all duration-500"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Summary -->
      <div class="mt-auto pt-4 border-t border-gray-200">
        <h3 class="text-xs font-semibold text-gray-500 mb-1">
          Collected Data
        </h3>
        <div
          id="data-summary"
          class="text-xs text-gray-600 space-y-0.5"
        >
          <p>No data collected yet</p>
        </div>

        <button
          onclick="resetOnboarding()"
          class="mt-3 w-full px-3 py-1.5 rounded-lg border border-red-200 text-[11px] text-red-600 hover:bg-red-50"
        >
          Reset onboarding
        </button>
      </div>
    </aside>

    <!-- Main area -->
    <main class="flex-1 flex flex-col bg-white">
      <!-- Step header -->
      <div class="border-b border-gray-200 bg-white px-6 py-3 flex items-center justify-between">
        <div class="max-w-[1100px] w-full mx-auto">
          <h2 id="step-title" class="text-sm font-semibold text-gray-900">
            Introduction
          </h2>
          <p id="step-subtitle" class="text-xs text-gray-500">
            Tell me who you are and which company you represent.
          </p>
        </div>
      </div>

      <!-- Step content (above global input) -->
      <div class="flex-1 overflow-hidden bg-white">
        <!-- INTRO -->
        <section id="step-intro" class="step-page h-full flex flex-col">
          <div
            id="chat-intro"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          ></div>
        </section>

        <!-- BRANDED TRACKING -->
        <section id="step-branded" class="step-page h-full flex flex-col hidden">
          <div
            id="chat-branded"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          ></div>
        </section>

        <!-- PRODUCT FEED -->
        <section id="step-feed" class="step-page h-full flex flex-col hidden">
          <div
            id="chat-feed"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          ></div>
        </section>

        <!-- PROGRAM ASSETS (WITH UPLOADS) -->
        <section id="step-assets" class="step-page h-full flex flex-col hidden">
          <div
            id="chat-assets"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          >
            <div
              class="mb-3 max-w-[1100px] w-full mx-auto p-3 bg-[#F7F9FF] border border-[#2A73FF]/30 text-[#2A73FF] rounded-[14px] text-sm"
            >
              Upload your logo, banners, T&Cs and additional documents using the
              sections below ðŸ‘‡
            </div>

            <!-- Upload module -->
            <div class="max-w-[1100px] w-full mx-auto">
              <h3 class="text-sm font-semibold text-gray-700 mb-3">
                Upload Program Assets
              </h3>

              <div class="space-y-4">
                <!-- Logo -->
                <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xs font-medium text-gray-700">Logo</h4>
                    <span class="text-xs text-gray-500">350Ã—130px</span>
                  </div>
                  <button
                    onclick="document.getElementById('logo-input').click()"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs"
                  >
                    Upload Logo
                  </button>
                  <input
                    type="file"
                    id="logo-input"
                    accept=".png,.jpg,.jpeg"
                    class="hidden"
                  />
                  <div id="logo-list" class="mt-2 space-y-1"></div>
                </div>

                <!-- Banners -->
                <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xs font-medium text-gray-700">Banners</h4>
                    <span class="text-xs text-gray-500">Multiple sizes</span>
                  </div>
                  <p class="text-xs text-gray-500 mb-2">
                    160Ã—600, 300Ã—250, 300Ã—600, 728Ã—90, 928Ã—70
                  </p>
                  <button
                    onclick="document.getElementById('banners-input').click()"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs"
                  >
                    Upload Banners
                  </button>
                  <input
                    type="file"
                    id="banners-input"
                    accept=".jpg,.jpeg,.gif,.png"
                    multiple
                    class="hidden"
                  />
                  <div id="banners-list" class="mt-2 space-y-1"></div>
                </div>

                <!-- Terms -->
                <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xs font-medium text-gray-700">
                      Terms &amp; Conditions
                    </h4>
                    <span class="text-xs text-gray-500">PDF</span>
                  </div>
                  <button
                    onclick="document.getElementById('terms-input').click()"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs"
                  >
                    Upload T&amp;Cs
                  </button>
                  <input
                    type="file"
                    id="terms-input"
                    accept=".pdf"
                    class="hidden"
                  />
                  <div id="terms-list" class="mt-2 space-y-1"></div>
                </div>

                <!-- Other docs -->
                <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xs font-medium text-gray-700">
                      Other Documents
                    </h4>
                    <span class="text-xs text-gray-500">Optional</span>
                  </div>
                  <button
                    onclick="document.getElementById('other-input').click()"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs"
                  >
                    Upload Files
                  </button>
                  <input
                    type="file"
                    id="other-input"
                    multiple
                    class="hidden"
                  />
                  <div id="other-list" class="mt-2 space-y-1"></div>
                </div>

                <!-- Send all -->
                <button
                  id="send-all-files"
                  class="w-full mt-1 px-4 py-2.5 bg-[#2A73FF] text-white rounded-lg hover:bg-[#1F5ED8] transition-colors text-sm font-medium shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed"
                  disabled
                >
                  Send All Files
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- IP ADDRESSES -->
        <section id="step-ip" class="step-page h-full flex flex-col hidden">
          <div
            id="chat-ip"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          ></div>
        </section>

        <!-- TRACKING SCRIPTS -->
        <section id="step-scripts" class="step-page h-full flex flex-col hidden">
          <div
            id="chat-scripts"
            class="flex-1 overflow-y-auto p-6 space-y-3 pb-32"
          ></div>
        </section>
      </div>

      <!-- GLOBAL FIXED INPUT BAR -->
      <div class="fixed bottom-0 left-[320px] right-0 bg-white border-t border-gray-200 p-3 z-50">
        <div class="max-w-[1100px] w-full mx-auto flex gap-2">
          <input
            id="global-input"
            type="text"
            placeholder="Type your message..."
            class="flex-1 px-3 py-2 text-sm 
                   border border-gray-300 
                   rounded-xl 
                   bg-white 
                   text-gray-900 
                   placeholder-gray-500 
                   focus:outline-none focus:ring-2 focus:ring-[#2A73FF] focus:border-transparent"
          />
          <button
            id="global-send"
            class="px-4 py-2 bg-[#2A73FF] text-white text-sm rounded-xl hover:bg-[#1F5ED8] transition shadow-md"
          >
            Send
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const N8N_WEBHOOK_URL =
      'https://harrytradedoubler2026.app.n8n.cloud/webhook/onboarding-chat';
    const STEPS = ['intro', 'branded', 'feed', 'assets', 'ip', 'scripts'];

    const stepMeta = {
      intro: {
        title: 'Introduction',
        subtitle: 'Tell me who you are and which company you represent.',
      },
      branded: {
        title: 'Branded Tracking',
        subtitle: 'Weâ€™ll configure your visit.* and statics.* tracking domains.',
      },
      feed: {
        title: 'Product Feed',
        subtitle: 'Share your product feed URL and format so we can map it.',
      },
      assets: {
        title: 'Program Assets',
        subtitle: 'Upload your logo, banners, T&Cs and additional program documents.',
      },
      ip: {
        title: 'IP Addresses',
        subtitle: 'Provide office IPs so we can exclude internal traffic from tracking.',
      },
      scripts: {
        title: 'Tracking Scripts',
        subtitle: 'Weâ€™ll walk through integrating your Tradedoubler tags.',
      },
    };

    // ==========================
    // STATE
    // ==========================
    let currentStep = 'intro';
    let sessionId = generateSessionId();
    let histories = {}; // per-step: { step: [{role, content}] }
    let onboardingData = {};
    let checklist = {
      intro: false,
      brandedTracking: false,
      productFeed: false,
      assets: false,
      ipAddresses: false,
      trackingScripts: false,
    };
    let uploadedFiles = {
      logo: [],
      banners: [],
      terms: [],
      other: [],
    };

    // DOM
    const stepTitle = document.getElementById('step-title');
    const stepSubtitle = document.getElementById('step-subtitle');
    const navButtons = document.querySelectorAll('.step-nav-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressPct = document.getElementById('progress-percentage');
    const dataSummary = document.getElementById('data-summary');
    const sendAllFilesBtn = document.getElementById('send-all-files');

    const logoInput = document.getElementById('logo-input');
    const bannersInput = document.getElementById('banners-input');
    const termsInput = document.getElementById('terms-input');
    const otherInput = document.getElementById('other-input');

    const globalInput = document.getElementById('global-input');
    const globalSend = document.getElementById('global-send');

    // ==========================
    // STORAGE
    // ==========================
    function saveState() {
      localStorage.setItem('td_step', currentStep);
      localStorage.setItem('td_histories', JSON.stringify(histories));
      localStorage.setItem('td_onboarding_data', JSON.stringify(onboardingData));
      localStorage.setItem('td_checklist', JSON.stringify(checklist));
      localStorage.setItem('td_uploaded_files', JSON.stringify(uploadedFiles));
      localStorage.setItem('td_has_visited', '1');
    }

    function loadState() {
      const s = localStorage.getItem('td_step');
      const h = localStorage.getItem('td_histories');
      const d = localStorage.getItem('td_onboarding_data');
      const c = localStorage.getItem('td_checklist');
      const f = localStorage.getItem('td_uploaded_files');

      if (s && STEPS.includes(s)) currentStep = s;
      histories = h ? JSON.parse(h) : {};
      onboardingData = d ? JSON.parse(d) : {};
      checklist = c ? JSON.parse(c) : checklist;
      uploadedFiles = f ? JSON.parse(f) : uploadedFiles;
    }

    function resetOnboarding() {
      localStorage.removeItem('td_step');
      localStorage.removeItem('td_histories');
      localStorage.removeItem('td_onboarding_data');
      localStorage.removeItem('td_checklist');
      localStorage.removeItem('td_uploaded_files');
      localStorage.removeItem('td_has_visited');
      location.reload();
    }

    // ==========================
    // INIT
    // ==========================
    loadState();
    const hasVisitedBefore = localStorage.getItem('td_has_visited') === '1';

    STEPS.forEach((step) => {
      if (!Array.isArray(histories[step])) histories[step] = [];
    });

    // Seed intro on first visit
    if (!hasVisitedBefore && histories.intro.length === 0) {
      histories.intro.push({
        role: 'assistant',
        content:
          "Hi! ðŸ‘‹ I'm your Tradedoubler onboarding assistant.\n\nWe'll go through your setup step by step.\n\nLetâ€™s start with a quick introduction. What's your name and company?",
      });
    }

    // Welcome back on current step
    if (hasVisitedBefore && histories[currentStep].length > 0) {
      histories[currentStep].unshift({
        role: 'assistant',
        content:
          "Welcome back ðŸ‘‹ Here's where we left off last time. We can continue from this step or jump to any step in the sidebar.",
      });
    }

    // Sidebar nav
    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const step = btn.getAttribute('data-step');
        goToStep(step);
      });
    });

    // Global input events (always sends to currentStep)
    if (globalSend) {
      globalSend.addEventListener('click', () => sendMessage());
    }
    if (globalInput) {
      globalInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Upload listeners
    if (logoInput) logoInput.addEventListener('change', (e) => handleFileUpload(e, 'logo', 'logo-list'));
    if (bannersInput) bannersInput.addEventListener('change', (e) => handleFileUpload(e, 'banners', 'banners-list'));
    if (termsInput) termsInput.addEventListener('change', (e) => handleFileUpload(e, 'terms', 'terms-list'));
    if (otherInput) otherInput.addEventListener('change', (e) => handleFileUpload(e, 'other', 'other-list'));
    if (sendAllFilesBtn) sendAllFilesBtn.addEventListener('click', sendAllFiles);

    // Initial UI render
    goToStep(currentStep);
    updateChecklistUI();
    updateDataSummary();
    updateFileLists();
    updateSendAllButton();

    // ==========================
    // CORE
    // ==========================
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
    }

    function goToStep(step) {
      if (!STEPS.includes(step)) step = 'intro';
      currentStep = step;

      document.querySelectorAll('.step-page').forEach((s) => s.classList.add('hidden'));
      document.getElementById('step-' + step).classList.remove('hidden');

      stepTitle.textContent = stepMeta[step].title;
      stepSubtitle.textContent = stepMeta[step].subtitle;

      navButtons.forEach((btn) => {
        const s = btn.getAttribute('data-step');
        if (s === step) {
          btn.classList.add('bg-[#2A73FF]', 'text-white', 'shadow-md');
        } else {
          btn.classList.remove('bg-[#2A73FF]', 'text-white', 'shadow-md');
        }
      });

      const chatEl = document.getElementById('chat-' + step);
      chatEl.innerHTML = '';
      histories[step].forEach((m) => addMessageToChat(step, m.role, m.content));

      saveState();
    }

    async function sendMessage() {
      if (!globalInput) return;
      let text = globalInput.value.trim();
      if (!text) return;

      let step = currentStep;
      const lower = text.toLowerCase();

      // If they mention assets/creative, auto-move them into the Assets step
      if (
        step !== 'assets' &&
        (lower.includes('upload') ||
          lower.includes('banner') ||
          lower.includes('logo') ||
          lower.includes('creative') ||
          lower.includes('t&c') ||
          lower.includes('terms'))
      ) {
        step = 'assets';
        goToStep('assets');
      }

      const chatEl = document.getElementById('chat-' + step);
      if (!chatEl) return;

      histories[step].push({ role: 'user', content: text });
      addMessageToChat(step, 'user', text);
      globalInput.value = '';

      const loadingId = addLoadingIndicator(step);

      try {
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            step,
            message: text,
            conversationHistory: histories[step],
            onboardingData,
            checklist,
            uploadedFiles,
          }),
        });

        const data = await response.json();
        removeLoadingIndicator(loadingId);

        histories[step].push({ role: 'assistant', content: data.response });
        addMessageToChat(step, 'assistant', data.response);

        if (data.onboardingData) onboardingData = data.onboardingData;
        if (data.checklist) checklist = data.checklist;

        if (data.triggerGoToStep && STEPS.includes(data.triggerGoToStep)) {
          goToStep(data.triggerGoToStep);
        }

        updateChecklistUI();
        updateDataSummary();
        saveState();
      } catch (err) {
        console.error(err);
        removeLoadingIndicator(loadingId);
        const msg =
          'I ran into an issue responding just now. Please try again in a moment.';
        histories[step].push({ role: 'assistant', content: msg });
        addMessageToChat(step, 'assistant', msg);
      }
    }

    function addMessageToChat(step, role, content) {
      const chatEl = document.getElementById('chat-' + step);
      if (!chatEl) return;

      const wrapper = document.createElement('div');
      wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex ' + (role === 'user' ? 'justify-end' : 'justify-start');

      const bubble = document.createElement('div');
      bubble.className =
        'max-w-2xl px-3 py-2 rounded-[14px] text-sm chat-message bg-[#2A73FF] text-white shadow-md';

      bubble.innerHTML = content
        .split('\n')
        .map((line) => {
          if (!line.trim()) return '<p class="mb-1">&nbsp;</p>';
          if (line.startsWith('â€¢') || line.startsWith('-')) {
            return `<p class="ml-4">${line}</p>`;
          }
          return `<p class="mb-1">${line}</p>`;
        })
        .join('');

      inner.appendChild(bubble);
      wrapper.appendChild(inner);
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addLoadingIndicator(step) {
      const chatEl = document.getElementById('chat-' + step);
      if (!chatEl) return;

      const id = `loading_${step}_${Date.now()}`;
      const wrapper = document.createElement('div');
      wrapper.id = id;
      wrapper.className = 'flex justify-start';

      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex justify-start';

      inner.innerHTML = `
        <div class="px-3 py-2 rounded-[14px] bg-white border border-gray-200">
          <div class="flex gap-1">
            <div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader"></div>
            <div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.15s"></div>
            <div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.3s"></div>
          </div>
        </div>
      `;
      wrapper.appendChild(inner);
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
      return id;
    }

    function removeLoadingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function updateChecklistUI() {
      const doneCount = Object.values(checklist).filter(Boolean).length;
      const total = Object.keys(checklist).length;
      const pct = Math.round((doneCount / total) * 100);
      progressPct.textContent = `${pct}%`;
      progressBar.style.width = `${pct}%`;
    }

    function updateDataSummary() {
      const parts = [];
      if (onboardingData.clientName)
        parts.push(`<p><strong>Client:</strong> ${onboardingData.clientName}</p>`);
      if (onboardingData.companyName)
        parts.push(`<p><strong>Company:</strong> ${onboardingData.companyName}</p>`);
      if (onboardingData.email)
        parts.push(`<p><strong>Email:</strong> ${onboardingData.email}</p>`);
      if (onboardingData.brandedTracking?.visit)
        parts.push(`<p><strong>Visit:</strong> ${onboardingData.brandedTracking.visit}</p>`);
      if (onboardingData.brandedTracking?.statics)
        parts.push(`<p><strong>Statics:</strong> ${onboardingData.brandedTracking.statics}</p>`);
      if (onboardingData.productFeedUrl)
        parts.push(`<p><strong>Feed URL:</strong> ${onboardingData.productFeedUrl}</p>`);
      if (onboardingData.officeIPs?.length)
        parts.push(`<p><strong>IPs:</strong> ${onboardingData.officeIPs.length} address(es)</p>`);

      dataSummary.innerHTML =
        parts.length > 0 ? parts.join('') : '<p>No data collected yet</p>';
    }

    // ==========================
    // FILE UPLOADS
    // ==========================
    function handleFileUpload(event, category, listId) {
      const files = Array.from(event.target.files);
      if (!files.length) return;

      const listElement = document.getElementById(listId);

      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles[category].push({
            name: file.name,
            type: file.type,
            size: file.size,
            data: e.target.result.split(',')[1],
            category,
          });

          const fileDiv = document.createElement('div');
          fileDiv.className =
            'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `
            <svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="flex-1 truncate text-xs">${file.name}</span>
            <button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          `;
          listElement.appendChild(fileDiv);

          updateSendAllButton();
          saveState();
        };
        reader.readAsDataURL(file);
      });

      event.target.value = '';
    }

    function removeFile(category, fileName) {
      uploadedFiles[category] = uploadedFiles[category].filter((f) => f.name !== fileName);
      updateFileLists();
      updateSendAllButton();
      saveState();
    }

    function updateFileLists() {
      const lists = {
        logo: 'logo-list',
        banners: 'banners-list',
        terms: 'terms-list',
        other: 'other-list',
      };

      Object.keys(lists).forEach((category) => {
        const listElement = document.getElementById(lists[category]);
        if (!listElement) return;
        listElement.innerHTML = '';

        (uploadedFiles[category] || []).forEach((file) => {
          const fileDiv = document.createElement('div');
          fileDiv.className =
            'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `
            <svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="flex-1 truncate text-xs">${file.name}</span>
            <button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          `;
          listElement.appendChild(fileDiv);
        });
      });
    }

    function updateSendAllButton() {
      if (!sendAllFilesBtn) return;
      const totalFiles = Object.values(uploadedFiles).reduce(
        (sum, arr) => sum + (arr ? arr.length : 0),
        0
      );
      sendAllFilesBtn.disabled = totalFiles === 0;
      sendAllFilesBtn.textContent =
        totalFiles > 0 ? `Send All Files (${totalFiles})` : 'Send All Files';
    }

    async function sendAllFiles() {
      const totalFiles = Object.values(uploadedFiles).reduce(
        (sum, arr) => sum + (arr ? arr.length : 0),
        0
      );
      if (totalFiles === 0) return;

      const filesSummary = Object.entries(uploadedFiles)
        .filter(([_, files]) => files && files.length > 0)
        .map(([category, files]) => `${category}: ${files.length} file(s)`)
        .join(', ');

      if (globalInput) {
        globalInput.value = `I'm uploading ${totalFiles} files: ${filesSummary}`;
        await sendMessage();
      }
    }
  </script>
</body>
</html>
