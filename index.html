<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradedoubler Onboarding Assistant</title>

  <!-- Brand font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Instrument Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .chat-message {
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .pulse-loader {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.4; }
    }
    .step-marker {
      scroll-margin-top: 20px;
    }
    .upload-panel {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .upload-panel.hidden {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-white text-gray-900 h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-gray-200 p-5 flex flex-col sticky top-0 h-screen overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h1 class="text-xl font-semibold text-[#2A73FF]">Tradedoubler</h1>
          <p class="text-xs text-gray-500" data-i18n="sidebar.subtitle">AI Onboarding Assistant</p>
        </div>
      </div>
      <div class="mb-5">
        <label for="language-select" class="text-[11px] font-semibold text-gray-500" data-i18n="sidebar.languageLabel">Language</label>
        <select
          id="language-select"
          class="mt-1 w-full text-xs border border-gray-200 rounded-lg px-2 py-1.5 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#2A73FF] focus:border-transparent"
        >
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="it">Italiano</option>
          <option value="de">Deutsch</option>
        </select>
      </div>

      <!-- Steps nav -->
      <div class="mb-5">
        <h2 class="text-xs font-semibold text-gray-500 mb-2" data-i18n="sidebar.onboardingSteps">
          Onboarding steps
        </h2>
        <nav id="steps-nav" class="space-y-1 text-sm">
          <button data-step="intro" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">1. Introduction</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="branded" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">2. Branded Tracking</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="feed" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">3. Product Feed</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="assets" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">4. Program Assets</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="ip" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">5. IP Addresses</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="scripts" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span class="step-label">6. Tracking Scripts</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
        </nav>
      </div>

      <!-- Progress -->
      <div class="mb-5">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-medium text-gray-600" data-i18n="sidebar.overallProgress">Overall Progress</span>
          <span id="progress-percentage" class="text-xs font-semibold text-[#2A73FF]">0%</span>
        </div>
        <div class="w-full h-1.5 rounded-full bg-gray-200 overflow-hidden">
          <div id="progress-bar" class="h-1.5 rounded-full bg-[#2A73FF] transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- Upload Assets Button -->
      <button
        id="toggle-upload-panel"
        class="mb-4 w-full px-3 py-2 bg-[#F7F9FF] border border-[#2A73FF]/30 text-[#2A73FF] rounded-lg text-sm font-medium hover:bg-[#2A73FF]/10 transition flex items-center justify-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <span data-i18n="sidebar.uploadAssets">Upload Assets</span>
      </button>

      <!-- Summary -->
      <div class="mt-auto pt-4 border-t border-gray-200">
        <h3 class="text-xs font-semibold text-gray-500 mb-1" data-i18n="sidebar.collectedData">Collected Data</h3>
        <div id="data-summary" class="text-xs text-gray-600 space-y-0.5">
          <p data-i18n="sidebar.noData">No data collected yet</p>
        </div>

        <button
          onclick="resetOnboarding()"
          class="mt-3 w-full px-3 py-1.5 rounded-lg border border-red-200 text-[11px] text-red-600 hover:bg-red-50"
        >
          <span data-i18n="sidebar.resetOnboarding">Reset onboarding</span>
        </button>
      </div>
    </aside>

    <!-- Main area -->
    <main class="flex-1 flex flex-col bg-white h-full overflow-hidden relative">
      <!-- Single Chat Container -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-3 pb-3"></div>

      <!-- GLOBAL INPUT BAR -->
      <div class="shrink-0 bg-white border-t border-gray-200 p-3">
        <div class="max-w-[1100px] w-full mx-auto flex gap-2">
          <input
            id="global-input"
            type="text"
            placeholder="Type your message..."
            data-i18n-placeholder="chat.placeholder"
            class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-xl bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#2A73FF] focus:border-transparent"
          />
          <button
            id="global-send"
            class="px-4 py-2 bg-[#2A73FF] text-white text-sm rounded-xl hover:bg-[#1F5ED8] transition shadow-md"
          >
            <span data-i18n="chat.send">Send</span>
          </button>
        </div>
      </div>

      <!-- Upload Panel (Slide-out) -->
      <div id="upload-panel" class="upload-panel hidden fixed top-0 right-0 w-96 h-full bg-white border-l border-gray-200 shadow-xl z-50 overflow-y-auto">
        <div class="p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900" data-i18n="uploadPanel.title">Upload Assets</h3>
            <button id="close-upload-panel" class="text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <!-- Logo -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700" data-i18n="uploadPanel.logo">Logo</h4>
                <span class="text-xs text-gray-500" data-i18n="uploadPanel.logoHint">350×130px</span>
              </div>
              <button onclick="document.getElementById('logo-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                <span data-i18n="uploadPanel.uploadLogo">Upload Logo</span>
              </button>
              <input type="file" id="logo-input" accept=".png,.jpg,.jpeg" class="hidden" />
              <div id="logo-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Banners -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700" data-i18n="uploadPanel.banners">Banners</h4>
                <span class="text-xs text-gray-500" data-i18n="uploadPanel.bannersHint">Multiple sizes</span>
              </div>
              <p class="text-xs text-gray-500 mb-2" data-i18n="uploadPanel.bannerSizes">160×600, 300×250, 300×600, 728×90, 928×70</p>
              <button onclick="document.getElementById('banners-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                <span data-i18n="uploadPanel.uploadBanners">Upload Banners</span>
              </button>
              <input type="file" id="banners-input" accept=".jpg,.jpeg,.gif,.png" multiple class="hidden" />
              <div id="banners-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Terms & Conditions -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700" data-i18n="uploadPanel.terms">Terms & Conditions</h4>
                <span class="text-xs text-gray-500" data-i18n="uploadPanel.termsHint">PDF</span>
              </div>
              <button onclick="document.getElementById('terms-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                <span data-i18n="uploadPanel.uploadTerms">Upload T&Cs</span>
              </button>
              <input type="file" id="terms-input" accept=".pdf" class="hidden" />
              <div id="terms-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Other Documents -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700" data-i18n="uploadPanel.other">Other Documents</h4>
                <span class="text-xs text-gray-500" data-i18n="uploadPanel.otherHint">Optional</span>
              </div>
              <button onclick="document.getElementById('other-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                <span data-i18n="uploadPanel.uploadFiles">Upload Files</span>
              </button>
              <input type="file" id="other-input" multiple class="hidden" />
              <div id="other-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Send all -->
            <button
              id="send-all-files"
              class="w-full mt-1 px-4 py-2.5 bg-[#2A73FF] text-white rounded-lg hover:bg-[#1F5ED8] transition-colors text-sm font-medium shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed"
              disabled
            >
              <span data-i18n="uploadPanel.sendAll">Send All Files</span>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // CONFIG
    const N8N_WEBHOOK_URL = 'https://coe-n8n.common-eu-de.services.tddrift.net/webhook/onboarding-chat';
    const STEPS = ['intro', 'branded', 'feed', 'assets', 'ip', 'scripts'];

    const SUPPORTED_LANGS = ['en', 'es', 'fr', 'it', 'de'];
    const I18N = {
      en: {
        sidebar: {
          subtitle: 'AI Onboarding Assistant',
          languageLabel: 'Language',
          onboardingSteps: 'Onboarding steps',
          overallProgress: 'Overall Progress',
          uploadAssets: 'Upload Assets',
          collectedData: 'Collected Data',
          noData: 'No data collected yet',
          resetOnboarding: 'Reset onboarding',
        },
        steps: {
          intro: 'Introduction',
          branded: 'Branded Tracking',
          feed: 'Product Feed',
          assets: 'Program Assets',
          ip: 'IP Addresses',
          scripts: 'Tracking Scripts',
        },
        stepSubtitles: {
          intro: 'Tell me who you are and which company you represent.',
          branded: 'Configure your visit.* and statics.* tracking domains.',
          feed: 'Share your product feed URL and format.',
          assets: 'Upload your logo, banners, T&Cs and documents.',
          ip: 'Provide office IPs to exclude from tracking.',
          scripts: 'Integrate your Tradedoubler tracking tags.',
        },
        chat: {
          placeholder: 'Type your message...',
          send: 'Send',
          uploadingFiles: "I'm uploading {count} files: {summary}",
        },
        uploadPanel: {
          title: 'Upload Assets',
          logo: 'Logo',
          logoHint: '350×130px',
          uploadLogo: 'Upload Logo',
          banners: 'Banners',
          bannersHint: 'Multiple sizes',
          bannerSizes: '160×600, 300×250, 300×600, 728×90, 928×70',
          uploadBanners: 'Upload Banners',
          terms: 'Terms & Conditions',
          termsHint: 'PDF',
          uploadTerms: 'Upload T&Cs',
          other: 'Other Documents',
          otherHint: 'Optional',
          uploadFiles: 'Upload Files',
          sendAll: 'Send All Files',
        },
        summary: {
          client: 'Client',
          company: 'Company',
          email: 'Email',
          visit: 'Visit',
          statics: 'Statics',
          feedUrl: 'Feed URL',
          ips: 'IPs',
        },
      },
      es: {
        sidebar: {
          subtitle: 'Asistente de onboarding con IA',
          languageLabel: 'Idioma',
          onboardingSteps: 'Pasos de onboarding',
          overallProgress: 'Progreso general',
          uploadAssets: 'Subir recursos',
          collectedData: 'Datos recopilados',
          noData: 'Aún no hay datos recopilados',
          resetOnboarding: 'Reiniciar onboarding',
        },
        steps: {
          intro: 'Introducción',
          branded: 'Seguimiento de marca',
          feed: 'Feed de productos',
          assets: 'Activos del programa',
          ip: 'Direcciones IP',
          scripts: 'Scripts de seguimiento',
        },
        stepSubtitles: {
          intro: 'Dime quién eres y a qué empresa representas.',
          branded: 'Configura tus dominios visit.* y statics.*.',
          feed: 'Comparte la URL y el formato de tu feed de productos.',
          assets: 'Sube tu logo, banners, T&C y documentos.',
          ip: 'Proporciona las IPs de oficina para excluirlas del seguimiento.',
          scripts: 'Integra las etiquetas de seguimiento de Tradedoubler.',
        },
        chat: {
          placeholder: 'Escribe tu mensaje...',
          send: 'Enviar',
          uploadingFiles: 'Estoy subiendo {count} archivos: {summary}',
        },
        uploadPanel: {
          title: 'Subir recursos',
          logo: 'Logo',
          logoHint: '350×130px',
          uploadLogo: 'Subir logo',
          banners: 'Banners',
          bannersHint: 'Varios tamaños',
          bannerSizes: '160×600, 300×250, 300×600, 728×90, 928×70',
          uploadBanners: 'Subir banners',
          terms: 'Términos y condiciones',
          termsHint: 'PDF',
          uploadTerms: 'Subir T&C',
          other: 'Otros documentos',
          otherHint: 'Opcional',
          uploadFiles: 'Subir archivos',
          sendAll: 'Enviar todos los archivos',
        },
        summary: {
          client: 'Cliente',
          company: 'Empresa',
          email: 'Correo',
          visit: 'Visit',
          statics: 'Statics',
          feedUrl: 'URL del feed',
          ips: 'IPs',
        },
      },
      fr: {
        sidebar: {
          subtitle: "Assistant d'onboarding IA",
          languageLabel: 'Langue',
          onboardingSteps: "Étapes d'onboarding",
          overallProgress: 'Progression globale',
          uploadAssets: 'Importer des ressources',
          collectedData: 'Données collectées',
          noData: 'Aucune donnée collectée',
          resetOnboarding: "Réinitialiser l'onboarding",
        },
        steps: {
          intro: 'Introduction',
          branded: 'Suivi de marque',
          feed: 'Flux produits',
          assets: 'Ressources du programme',
          ip: 'Adresses IP',
          scripts: 'Scripts de suivi',
        },
        stepSubtitles: {
          intro: 'Dites-moi qui vous êtes et quelle entreprise vous représentez.',
          branded: 'Configurez vos domaines visit.* et statics.*.',
          feed: 'Partagez l’URL et le format de votre flux produits.',
          assets: 'Importez votre logo, bannières, CGU et documents.',
          ip: 'Fournissez les IP du bureau à exclure du suivi.',
          scripts: 'Intégrez les balises de suivi Tradedoubler.',
        },
        chat: {
          placeholder: 'Tapez votre message...',
          send: 'Envoyer',
          uploadingFiles: "J'importe {count} fichiers : {summary}",
        },
        uploadPanel: {
          title: 'Importer des ressources',
          logo: 'Logo',
          logoHint: '350×130px',
          uploadLogo: 'Importer le logo',
          banners: 'Bannières',
          bannersHint: 'Tailles multiples',
          bannerSizes: '160×600, 300×250, 300×600, 728×90, 928×70',
          uploadBanners: 'Importer des bannières',
          terms: 'Conditions générales',
          termsHint: 'PDF',
          uploadTerms: 'Importer les CGU',
          other: 'Autres documents',
          otherHint: 'Optionnel',
          uploadFiles: 'Importer des fichiers',
          sendAll: 'Envoyer tous les fichiers',
        },
        summary: {
          client: 'Client',
          company: 'Société',
          email: 'Email',
          visit: 'Visit',
          statics: 'Statics',
          feedUrl: 'URL du flux',
          ips: 'IPs',
        },
      },
      it: {
        sidebar: {
          subtitle: 'Assistente di onboarding IA',
          languageLabel: 'Lingua',
          onboardingSteps: "Fasi di onboarding",
          overallProgress: 'Progresso complessivo',
          uploadAssets: 'Carica risorse',
          collectedData: 'Dati raccolti',
          noData: 'Nessun dato raccolto',
          resetOnboarding: 'Reimposta onboarding',
        },
        steps: {
          intro: 'Introduzione',
          branded: 'Tracking brandizzato',
          feed: 'Feed prodotti',
          assets: 'Asset del programma',
          ip: 'Indirizzi IP',
          scripts: 'Script di tracciamento',
        },
        stepSubtitles: {
          intro: 'Dimmi chi sei e quale azienda rappresenti.',
          branded: 'Configura i domini visit.* e statics.*.',
          feed: 'Condividi URL e formato del feed prodotti.',
          assets: 'Carica logo, banner, T&C e documenti.',
          ip: 'Fornisci gli IP dell’ufficio da escludere dal tracciamento.',
          scripts: 'Integra i tag di tracciamento Tradedoubler.',
        },
        chat: {
          placeholder: 'Scrivi il tuo messaggio...',
          send: 'Invia',
          uploadingFiles: 'Sto caricando {count} file: {summary}',
        },
        uploadPanel: {
          title: 'Carica risorse',
          logo: 'Logo',
          logoHint: '350×130px',
          uploadLogo: 'Carica logo',
          banners: 'Banner',
          bannersHint: 'Più dimensioni',
          bannerSizes: '160×600, 300×250, 300×600, 728×90, 928×70',
          uploadBanners: 'Carica banner',
          terms: 'Termini e condizioni',
          termsHint: 'PDF',
          uploadTerms: 'Carica T&C',
          other: 'Altri documenti',
          otherHint: 'Opzionale',
          uploadFiles: 'Carica file',
          sendAll: 'Invia tutti i file',
        },
        summary: {
          client: 'Cliente',
          company: 'Azienda',
          email: 'Email',
          visit: 'Visit',
          statics: 'Statics',
          feedUrl: 'URL del feed',
          ips: 'IP',
        },
      },
      de: {
        sidebar: {
          subtitle: 'KI-Onboarding-Assistent',
          languageLabel: 'Sprache',
          onboardingSteps: 'Onboarding-Schritte',
          overallProgress: 'Gesamtfortschritt',
          uploadAssets: 'Assets hochladen',
          collectedData: 'Erfasste Daten',
          noData: 'Noch keine Daten erfasst',
          resetOnboarding: 'Onboarding zurücksetzen',
        },
        steps: {
          intro: 'Einführung',
          branded: 'Marken-Tracking',
          feed: 'Produkt-Feed',
          assets: 'Programm-Assets',
          ip: 'IP-Adressen',
          scripts: 'Tracking-Skripte',
        },
        stepSubtitles: {
          intro: 'Sag mir, wer du bist und welches Unternehmen du vertrittst.',
          branded: 'Konfiguriere deine visit.* und statics.* Domains.',
          feed: 'Teile die URL und das Format deines Produkt-Feeds.',
          assets: 'Lade Logo, Banner, AGB und Dokumente hoch.',
          ip: 'Gib Büro-IPs an, die vom Tracking ausgeschlossen werden.',
          scripts: 'Integriere die Tradedoubler-Tracking-Tags.',
        },
        chat: {
          placeholder: 'Nachricht eingeben...',
          send: 'Senden',
          uploadingFiles: 'Ich lade {count} Dateien hoch: {summary}',
        },
        uploadPanel: {
          title: 'Assets hochladen',
          logo: 'Logo',
          logoHint: '350×130px',
          uploadLogo: 'Logo hochladen',
          banners: 'Banner',
          bannersHint: 'Mehrere Größen',
          bannerSizes: '160×600, 300×250, 300×600, 728×90, 928×70',
          uploadBanners: 'Banner hochladen',
          terms: 'AGB',
          termsHint: 'PDF',
          uploadTerms: 'AGB hochladen',
          other: 'Weitere Dokumente',
          otherHint: 'Optional',
          uploadFiles: 'Dateien hochladen',
          sendAll: 'Alle Dateien senden',
        },
        summary: {
          client: 'Kunde',
          company: 'Unternehmen',
          email: 'E-Mail',
          visit: 'Visit',
          statics: 'Statics',
          feedUrl: 'Feed-URL',
          ips: 'IPs',
        },
      },
    };

    const WELCOME_MESSAGES = {
      en: "Hi! I'm your Tradedoubler onboarding assistant.\n\nI'll walk you through your technical setup step-by-step.\n\nWhat you'll need from you:\n\n- Website domain\n\n- Product feed URL\n\n- Office IP addresses\n\n- Company logos & banners\n\nWhat requires your technical team:\n\n- DNS/CNAME setup (I'll provide exact records)\n\n- Tracking script integration (I'll provide the code)\n\n- Test transaction (I'll provide test link)\n\nDon't have everything ready? That's fine! We can pause at any step and you can provide information later. I'll make a note of what's pending.\n\nNeed to understand something better? Just ask!\n\nLet's get started! What's your name, company, and email address?",
      es: "¡Hola! Soy tu asistente de onboarding de Tradedoubler.\n\nTe guiaré por la configuración técnica paso a paso.\n\nLo que necesito de ti:\n\n- Dominio del sitio web\n\n- URL del feed de productos\n\n- Direcciones IP de oficina\n\n- Logos y banners de la empresa\n\nLo que requiere tu equipo técnico:\n\n- Configuración DNS/CNAME (proporcionaré los registros exactos)\n\n- Integración del script de seguimiento (proporcionaré el código)\n\n- Transacción de prueba (proporcionaré el enlace de prueba)\n\n¿No tienes todo listo? No pasa nada. Podemos pausar en cualquier paso y puedes proporcionar la información más tarde. Tomaré nota de lo pendiente.\n\n¿Necesitas entender algo mejor? Solo pregunta.\n\n¡Empecemos! ¿Cuál es tu nombre, empresa y correo electrónico?",
      fr: "Bonjour! Je suis votre assistant d'onboarding Tradedoubler.\n\nJe vais vous guider étape par étape dans la configuration technique.\n\nCe dont j'ai besoin de votre part:\n\n- Nom de domaine du site\n\n- URL du flux produits\n\n- Adresses IP du bureau\n\n- Logos et bannières de l'entreprise\n\nCe qui nécessite votre équipe technique:\n\n- Configuration DNS/CNAME (je fournirai les enregistrements exacts)\n\n- Intégration du script de suivi (je fournirai le code)\n\n- Transaction de test (je fournirai le lien de test)\n\nVous n'avez pas tout prêt? Aucun souci. Nous pouvons mettre en pause à n'importe quelle étape et vous pourrez fournir les informations plus tard. Je noterai ce qui manque.\n\nBesoin d'une explication? Demandez-moi.\n\nCommençons! Quel est votre nom, votre société et votre adresse email?",
      it: "Ciao! Sono il tuo assistente di onboarding Tradedoubler.\n\nTi guiderò nella configurazione tecnica passo dopo passo.\n\nCosa mi serve da te:\n\n- Dominio del sito web\n\n- URL del feed prodotti\n\n- Indirizzi IP dell'ufficio\n\n- Loghi e banner dell'azienda\n\nCosa richiede il tuo team tecnico:\n\n- Configurazione DNS/CNAME (fornirò i record esatti)\n\n- Integrazione dello script di tracciamento (fornirò il codice)\n\n- Transazione di test (fornirò il link di test)\n\nNon hai tutto pronto? Nessun problema. Possiamo mettere in pausa in qualsiasi fase e potrai fornire le informazioni più tardi. Terrò nota di ciò che manca.\n\nVuoi capire meglio qualcosa? Chiedimi pure.\n\nIniziamo! Qual è il tuo nome, azienda ed email?",
      de: "Hallo! Ich bin dein Tradedoubler-Onboarding-Assistent.\n\nIch begleite dich Schritt für Schritt durch das technische Setup.\n\nWas ich von dir brauche:\n\n- Website-Domain\n\n- Produkt-Feed-URL\n\n- Büro-IP-Adressen\n\n- Logos und Banner des Unternehmens\n\nWas dein Technikteam benötigt:\n\n- DNS/CNAME-Setup (ich liefere die genauen Einträge)\n\n- Integration des Tracking-Skripts (ich liefere den Code)\n\n- Testtransaktion (ich liefere den Testlink)\n\nDu hast noch nicht alles bereit? Kein Problem. Wir können jederzeit pausieren und du kannst die Informationen später liefern. Ich notiere, was noch fehlt.\n\nEtwas unklar? Frag einfach.\n\nLass uns starten! Wie heißen du, dein Unternehmen und deine E-Mail-Adresse?",
    };

    function getInitialLanguage() {
      const stored = localStorage.getItem('td_v2_lang');
      if (stored && SUPPORTED_LANGS.includes(stored)) return stored;
      const browser = (navigator.language || 'en').slice(0, 2).toLowerCase();
      return SUPPORTED_LANGS.includes(browser) ? browser : 'en';
    }

    function getStrings(lang) {
      return I18N[lang] || I18N.en;
    }

    function getTranslation(key, lang) {
      const source = getStrings(lang);
      return key.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : null), source);
    }

    function formatTemplate(value, tokens) {
      if (!value) return '';
      return Object.keys(tokens).reduce((out, key) => out.replace(`{${key}}`, tokens[key]), value);
    }

    function getWelcomeMessage(lang) {
      return WELCOME_MESSAGES[lang] || WELCOME_MESSAGES.en;
    }

    function getStepMeta(lang) {
      const strings = getStrings(lang);
      return {
        intro: { title: strings.steps.intro, subtitle: strings.stepSubtitles.intro },
        branded: { title: strings.steps.branded, subtitle: strings.stepSubtitles.branded },
        feed: { title: strings.steps.feed, subtitle: strings.stepSubtitles.feed },
        assets: { title: strings.steps.assets, subtitle: strings.stepSubtitles.assets },
        ip: { title: strings.steps.ip, subtitle: strings.stepSubtitles.ip },
        scripts: { title: strings.steps.scripts, subtitle: strings.stepSubtitles.scripts },
      };
    }

    let currentLanguage = getInitialLanguage();
    let stepMeta = getStepMeta(currentLanguage);

    const checklistMap = {
      intro: 'intro',
      branded: 'brandedTracking',
      feed: 'productFeed',
      assets: 'assets',
      ip: 'ipAddresses',
      scripts: 'trackingScripts'
    };

    // STATE - Single conversation history
    let sessionId = generateSessionId();
    let conversationHistory = []; // Array of {role, content, step, timestamp}
    let currentStep = 'intro';
    let onboardingData = {};
    let checklist = { intro: false, brandedTracking: false, productFeed: false, assets: false, ipAddresses: false, trackingScripts: false };
    let uploadedFiles = { logo: [], banners: [], terms: [], other: [] };

    // DOM
    const chatContainer = document.getElementById('chat-container');
    const navButtons = document.querySelectorAll('.step-nav-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressPct = document.getElementById('progress-percentage');
    const dataSummary = document.getElementById('data-summary');
    const sendAllFilesBtn = document.getElementById('send-all-files');
    const logoInput = document.getElementById('logo-input');
    const bannersInput = document.getElementById('banners-input');
    const termsInput = document.getElementById('terms-input');
    const otherInput = document.getElementById('other-input');
    const globalInput = document.getElementById('global-input');
    const globalSend = document.getElementById('global-send');
    const uploadPanel = document.getElementById('upload-panel');
    const toggleUploadBtn = document.getElementById('toggle-upload-panel');
    const closeUploadBtn = document.getElementById('close-upload-panel');
    const languageSelect = document.getElementById('language-select');

    // STORAGE
    function saveState() {
      localStorage.setItem('td_v2_session', sessionId);
      localStorage.setItem('td_v2_history', JSON.stringify(conversationHistory));
      localStorage.setItem('td_v2_step', currentStep);
      localStorage.setItem('td_v2_data', JSON.stringify(onboardingData));
      localStorage.setItem('td_v2_checklist', JSON.stringify(checklist));
      localStorage.setItem('td_v2_files', JSON.stringify(uploadedFiles));
    }

    function loadState() {
      const s = localStorage.getItem('td_v2_session');
      const h = localStorage.getItem('td_v2_history');
      const st = localStorage.getItem('td_v2_step');
      const d = localStorage.getItem('td_v2_data');
      const c = localStorage.getItem('td_v2_checklist');
      const f = localStorage.getItem('td_v2_files');

      if (s) sessionId = s;
      if (h) conversationHistory = JSON.parse(h);
      if (st && STEPS.includes(st)) currentStep = st;
      if (d) onboardingData = JSON.parse(d);
      if (c) checklist = JSON.parse(c);
      if (f) uploadedFiles = JSON.parse(f);
    }

    function resetOnboarding() {
      localStorage.removeItem('td_v2_session');
      localStorage.removeItem('td_v2_history');
      localStorage.removeItem('td_v2_step');
      localStorage.removeItem('td_v2_data');
      localStorage.removeItem('td_v2_checklist');
      localStorage.removeItem('td_v2_files');
      location.reload();
    }

    // INIT
    loadState();

    // Add welcome message if new session
    if (conversationHistory.length === 0) {
      conversationHistory.push({
        role: 'assistant',
        content: "Hi! I'm your Tradedoubler onboarding assistant.\n\nI'll walk you through your technical setup step-by-step.\n\nWhat you'll need from you:\n\n• Website domain\n\n• Product feed URL\n\n• Office IP addresses\n\n• Company logos & banners\n\nWhat requires your technical team:\n\n• DNS/CNAME setup (I'll provide exact records)\n\n• Tracking script integration (I'll provide the code)\n\n• Test transaction (I'll provide test link)\n\nDon't have everything ready? That's fine! We can pause at any step and you can provide information later. I'll make a note of what's pending.\n\nNeed to understand something better? Just ask!\n\nLet's get started! What's your name, company, and email address?",
        step: 'intro',
        timestamp: Date.now()
      });
      saveState();
    }

    // Render conversation
    normalizeConversationSteps();
    renderConversation();
    updateChecklistUI();
    updateDataSummary();
    updateFileLists();
    updateSendAllButton();
    highlightCurrentStep();

    // Event listeners
    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const step = btn.getAttribute('data-step');
        scrollToStep(step);
      });
    });

    globalSend.addEventListener('click', () => sendMessage());
    globalInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    logoInput.addEventListener('change', (e) => handleFileUpload(e, 'logo', 'logo-list'));
    bannersInput.addEventListener('change', (e) => handleFileUpload(e, 'banners', 'banners-list'));
    termsInput.addEventListener('change', (e) => handleFileUpload(e, 'terms', 'terms-list'));
    otherInput.addEventListener('change', (e) => handleFileUpload(e, 'other', 'other-list'));
    sendAllFilesBtn.addEventListener('click', sendAllFiles);

    toggleUploadBtn.addEventListener('click', () => {
      uploadPanel.classList.remove('hidden');
    });
    closeUploadBtn.addEventListener('click', () => {
      uploadPanel.classList.add('hidden');
    });

    // CORE FUNCTIONS
    function escapeRegExp(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function inferStepFromText(text, contextStep = null) {
      if (!text) return null;
      const lower = text.toLowerCase();

      if (
        lower.includes("i'll walk you through") ||
        lower.includes("what you'll need from you") ||
        lower.includes("let's get started") ||
        lower.includes("what requires your technical team")
      ) {
        return 'intro';
      }

      const transitionPhrases = [
        'next step',
        'move on to',
        'moving on to',
        'proceed to',
        'let\'s talk about',
        'now let\'s',
        'we can move to',
        'we can move on to',
        'we can proceed to',
      ];
      const hasTransition = transitionPhrases.some((phrase) => lower.includes(phrase));

      const stepKeywords = {
        intro: {
          strong: ['what\'s your name', 'what is your name', 'email address', 'name and company', 'name, company'],
          weak: ['name', 'company', 'email'],
        },
        branded: {
          strong: ['branded tracking', 'cname', 'subdomain', 'visit.', 'statics.'],
          weak: ['dns', 'branded'],
        },
        feed: {
          strong: ['product feed', 'product feeds', 'feed url', 'productfeed'],
          weak: ['feed', 'catalog'],
        },
        assets: {
          strong: ['program assets', 'terms and conditions', 't&c', 't&cs'],
          weak: ['upload', 'logo', 'logos', 'banner', 'banners', 'asset', 'assets', 'document', 'documents', 'terms'],
        },
        ip: {
          strong: ['ip address', 'ip addresses', 'office ip', 'office ips', 'ip list'],
          weak: ['ip', 'ips', 'whitelist', 'exclude ip'],
        },
        scripts: {
          strong: ['tracking script', 'tracking scripts', 'tracking code', 'tracking tag'],
          weak: ['script', 'scripts', 'tag', 'tags', 'pixel', 'snippet'],
        },
      };

      const priority = ['feed', 'assets', 'scripts', 'ip', 'branded', 'intro'];
      let bestStep = null;
      let bestScore = 0;
      let matchedSteps = [];

      Object.entries(stepKeywords).forEach(([step, keywordGroups]) => {
        let strongHits = 0;
        let weakHits = 0;

        keywordGroups.strong.forEach((keyword) => {
          if (keyword.includes(' ') || keyword.includes('.')) {
            if (lower.includes(keyword)) strongHits += 1;
            return;
          }
          const pattern = new RegExp(`\\b${escapeRegExp(keyword)}\\b`, 'i');
          if (pattern.test(lower)) strongHits += 1;
        });

        keywordGroups.weak.forEach((keyword) => {
          if (keyword.includes(' ') || keyword.includes('.')) {
            if (lower.includes(keyword)) weakHits += 1;
            return;
          }
          const pattern = new RegExp(`\\b${escapeRegExp(keyword)}\\b`, 'i');
          if (pattern.test(lower)) weakHits += 1;
        });

        const score = strongHits * 2 + weakHits;
        const qualifies = score > 0 && (hasTransition || strongHits > 0 || weakHits >= 2);

        if (qualifies) matchedSteps.push(step);

        if (score > bestScore) {
          bestScore = score;
          bestStep = step;
        } else if (score > 0 && score === bestScore) {
          if (priority.indexOf(step) < priority.indexOf(bestStep)) {
            bestStep = step;
          }
        }
      });

      if (matchedSteps.length === 0) return null;

      if (matchedSteps.length > 1 && contextStep) {
        const sequence = ['intro', 'branded', 'feed', 'assets', 'ip', 'scripts'];
        const contextIndex = sequence.indexOf(contextStep);
        if (contextIndex >= 0) {
          const nextMatch = sequence.slice(contextIndex + 1).find((step) => matchedSteps.includes(step));
          if (nextMatch) return nextMatch;
        }
      }

      if (!hasTransition && matchedSteps.length > 1) return null;
      return bestStep;
    }

    function normalizeConversationSteps() {
      let updated = false;
      let stepCursor = currentStep || 'intro';

      conversationHistory.forEach((msg) => {
        if (msg.role === 'assistant') {
          const inferred = inferStepFromText(msg.content, stepCursor);
          if (inferred) stepCursor = inferred;
        }
        if (msg.step !== stepCursor) {
          msg.step = stepCursor;
          updated = true;
        }
      });

      if (stepCursor && stepCursor !== currentStep) currentStep = stepCursor;
      if (updated) saveState();
    }

    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
    }

    function renderConversation() {
      chatContainer.innerHTML = '';
      let lastStep = null;

      conversationHistory.forEach((msg, index) => {
        // Add step marker if step changed
        if (msg.step && msg.step !== lastStep) {
          addStepMarker(msg.step);
          lastStep = msg.step;
        }
        addMessageToDOM(msg.role, msg.content, msg.step, false);
      });

      // Scroll to bottom
      scrollToBottom();
    }

    function addStepMarker(step) {
      const meta = stepMeta[step];
      if (!meta) return;

      const marker = document.createElement('div');
      marker.id = `step-marker-${step}`;
      marker.className = 'step-marker flex items-center gap-3 py-4 my-2';
      marker.innerHTML = `
        <div class="flex-1 h-px bg-gray-200"></div>
        <div class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full">
          <span class="text-xs font-medium text-gray-600">${meta.title}</span>
        </div>
        <div class="flex-1 h-px bg-gray-200"></div>
      `;
      chatContainer.appendChild(marker);
    }

    function addMessageToDOM(role, content, step, animate = true) {
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
      if (step) wrapper.setAttribute('data-step', step);

      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex flex-col ' + (role === 'user' ? 'items-end' : 'items-start');

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'max-w-2xl px-3 py-2 rounded-[14px] text-sm bg-gray-100 text-gray-900 shadow-md' + (animate ? ' chat-message' : '')
        : 'max-w-2xl px-3 py-2 rounded-[14px] text-sm bg-[#2A73FF] text-white shadow-md' + (animate ? ' chat-message' : '');

      bubble.innerHTML = content.split('\n').map((line) => {
        if (!line.trim()) return '<p class="mb-1">&nbsp;</p>';
        if (line.startsWith('•') || line.startsWith('-')) return `<p class="ml-4">${line}</p>`;
        return `<p class="mb-1">${line}</p>`;
      }).join('');

      const timestamp = document.createElement('div');
      timestamp.className = 'text-xs text-gray-400 mt-1 px-1';
      timestamp.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

      inner.appendChild(bubble);
      inner.appendChild(timestamp);
      wrapper.appendChild(inner);
      chatContainer.appendChild(wrapper);
    }

    function scrollToStep(step) {
      const marker = document.getElementById(`step-marker-${step}`);
      if (marker) {
        marker.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        // No messages for this step yet - scroll to bottom and set as current
        currentStep = step;
        highlightCurrentStep();
        scrollToBottom();
      }
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 150);
      });
    }

    function highlightCurrentStep() {
      navButtons.forEach((btn) => {
        const s = btn.getAttribute('data-step');
        if (s === currentStep) {
          btn.classList.add('bg-[#2A73FF]', 'text-white', 'shadow-md');
        } else {
          btn.classList.remove('bg-[#2A73FF]', 'text-white', 'shadow-md');
        }
      });
    }

    async function sendMessage() {
      const text = globalInput.value.trim();
      if (!text) return;

      // Check if we need to add a step marker
      const lastMsg = conversationHistory[conversationHistory.length - 1];
      const needsMarker = !lastMsg || lastMsg.step !== currentStep;

      // Add user message
      const userMsg = { role: 'user', content: text, step: currentStep, timestamp: Date.now() };
      conversationHistory.push(userMsg);

      if (needsMarker) {
        addStepMarker(currentStep);
      }
      addMessageToDOM('user', text, currentStep, true);
      globalInput.value = '';
      highlightCurrentStep();
      scrollToBottom();
      saveState();

      // Show loading
      const loadingId = addLoadingIndicator();

      try {
        // Build trimmed history for API (last 12 messages)
        const trimmedHistory = conversationHistory.slice(-12).map(m => ({ role: m.role, content: m.content }));

        const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
        const lower = text.toLowerCase();
        const filesPayload = totalFiles > 0 && lower.includes('upload') ? uploadedFiles : {};

        const qs = new URLSearchParams(window.location.search);
        const programID = qs.get('programID');
        console.log('programID sent to backend:', programID);

        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            step: currentStep,
            message: text,
            programID,
            conversationHistory: trimmedHistory,
            onboardingData,
            checklist,
            uploadedFiles: filesPayload,
          }),
        });

        const data = await response.json();
        removeLoadingIndicator(loadingId);

        // Add assistant response
        let responseStep = currentStep;
        if (data.triggerGoToStep && STEPS.includes(data.triggerGoToStep)) {
          responseStep = data.triggerGoToStep;
        } else {
          const inferredAssistantStep = inferStepFromText(data.response, currentStep);
          if (inferredAssistantStep) responseStep = inferredAssistantStep;
        }

        const assistantMsg = { role: 'assistant', content: data.response, step: responseStep, timestamp: Date.now() };
        conversationHistory.push(assistantMsg);
        addMessageToDOM('assistant', data.response, responseStep, true);

        // Update state from response
        if (data.onboardingData) onboardingData = data.onboardingData;
        if (data.checklist) checklist = data.checklist;

        // If backend suggests a step change or we inferred one
        if (responseStep && STEPS.includes(responseStep)) {
          currentStep = responseStep;
          highlightCurrentStep();
        }

        updateChecklistUI();
        updateDataSummary();
        scrollToBottom();
        saveState();
      } catch (err) {
        console.error(err);
        removeLoadingIndicator(loadingId);
        const errorMsg = { role: 'assistant', content: 'I ran into an issue responding just now. Please try again in a moment.', step: currentStep, timestamp: Date.now() };
        conversationHistory.push(errorMsg);
        addMessageToDOM('assistant', errorMsg.content, currentStep, true);
      }
    }

    function addLoadingIndicator() {
      const id = `loading_${Date.now()}`;
      const wrapper = document.createElement('div');
      wrapper.id = id;
      wrapper.className = 'flex justify-start';
      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex justify-start';
      inner.innerHTML = `<div class="px-3 py-2 rounded-[14px] bg-white border border-gray-200"><div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader"></div><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.15s"></div><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.3s"></div></div></div>`;
      wrapper.appendChild(inner);
      chatContainer.appendChild(wrapper);
      scrollToBottom();
      return id;
    }

    function removeLoadingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function updateChecklistUI() {
      const doneCount = Object.values(checklist).filter(Boolean).length;
      const total = Object.keys(checklist).length;
      const pct = Math.round((doneCount / total) * 100);
      progressPct.textContent = `${pct}%`;
      progressBar.style.width = `${pct}%`;

      // Update checkmarks on nav buttons
      navButtons.forEach((btn) => {
        const step = btn.getAttribute('data-step');
        const checkKey = checklistMap[step];
        const checkEl = btn.querySelector('.step-check');
        if (checkEl && checklist[checkKey]) {
          checkEl.classList.remove('hidden');
        } else if (checkEl) {
          checkEl.classList.add('hidden');
        }
      });
    }

    function updateDataSummary() {
      const parts = [];
      if (onboardingData.clientName) parts.push(`<p><strong>Client:</strong> ${onboardingData.clientName}</p>`);
      if (onboardingData.companyName) parts.push(`<p><strong>Company:</strong> ${onboardingData.companyName}</p>`);
      if (onboardingData.email) parts.push(`<p><strong>Email:</strong> ${onboardingData.email}</p>`);
      if (onboardingData.brandedTracking?.visit) parts.push(`<p><strong>Visit:</strong> ${onboardingData.brandedTracking.visit}</p>`);
      if (onboardingData.brandedTracking?.statics) parts.push(`<p><strong>Statics:</strong> ${onboardingData.brandedTracking.statics}</p>`);
      if (onboardingData.productFeedUrl) parts.push(`<p><strong>Feed URL:</strong> ${onboardingData.productFeedUrl}</p>`);
      if (onboardingData.officeIPs?.length) parts.push(`<p><strong>IPs:</strong> ${onboardingData.officeIPs.length} address(es)</p>`);
      dataSummary.innerHTML = parts.length > 0 ? parts.join('') : '<p>No data collected yet</p>';
    }

    function handleFileUpload(event, category, listId) {
      const files = Array.from(event.target.files);
      if (!files.length) return;
      const listElement = document.getElementById(listId);
      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles[category].push({ name: file.name, type: file.type, size: file.size, data: e.target.result.split(',')[1], category });
          const fileDiv = document.createElement('div');
          fileDiv.className = 'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `<svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg><span class="flex-1 truncate text-xs">${file.name}</span><button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>`;
          listElement.appendChild(fileDiv);
          updateSendAllButton();
          saveState();
        };
        reader.readAsDataURL(file);
      });
      event.target.value = '';
    }

    function removeFile(category, fileName) {
      uploadedFiles[category] = uploadedFiles[category].filter((f) => f.name !== fileName);
      updateFileLists();
      updateSendAllButton();
      saveState();
    }

    function updateFileLists() {
      const lists = { logo: 'logo-list', banners: 'banners-list', terms: 'terms-list', other: 'other-list' };
      Object.keys(lists).forEach((category) => {
        const listElement = document.getElementById(lists[category]);
        if (!listElement) return;
        listElement.innerHTML = '';
        (uploadedFiles[category] || []).forEach((file) => {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `<svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg><span class="flex-1 truncate text-xs">${file.name}</span><button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>`;
          listElement.appendChild(fileDiv);
        });
      });
    }

    function updateSendAllButton() {
      const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
      sendAllFilesBtn.disabled = totalFiles === 0;
      sendAllFilesBtn.textContent = totalFiles > 0 ? `Send All Files (${totalFiles})` : 'Send All Files';
    }

    async function sendAllFiles() {
      const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
      if (totalFiles === 0) return;
      const filesSummary = Object.entries(uploadedFiles).filter(([_, files]) => files && files.length > 0).map(([category, files]) => `${category}: ${files.length} file(s)`).join(', ');
      globalInput.value = `I'm uploading ${totalFiles} files: ${filesSummary}`;
      uploadPanel.classList.add('hidden');
      await sendMessage();
    }
  </script>
</body>
</html>
