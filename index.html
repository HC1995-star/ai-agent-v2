<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradedoubler Onboarding Assistant</title>

  <!-- Brand font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind config MUST come before CDN -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Instrument Sans', 'sans-serif'],
          },
          colors: {
            'td-blue': '#2A73FF',
            'td-blue-dark': '#1F5ED8',
            'td-bg-light': '#F7F9FF',
            'td-bg-dark': '#0E1117',
          },
          boxShadow: {
            brand: '0 4px 14px rgba(42, 115, 255, 0.18)',
          },
          borderRadius: {
            brand: '14px',
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Instrument Sans', sans-serif;
    }
    .chat-message {
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .pulse-loader {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-td-bg-light to-indigo-50 dark:from-td-bg-dark dark:to-black text-gray-900 dark:text-gray-100">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-80 bg-white dark:bg-[#111827] p-5 border-r border-gray-200 dark:border-gray-800 flex flex-col">
      <div class="flex items-center justify-between mb-5">
        <div>
          <h1 class="text-xl font-semibold text-td-blue">Tradedoubler</h1>
          <p class="text-xs text-gray-500 dark:text-gray-300">AI Onboarding Assistant</p>
        </div>
        <button
          onclick="toggleDarkMode()"
          class="px-2 py-1 rounded-full text-[11px] bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
          Theme
        </button>
      </div>

      <!-- Steps nav -->
      <div class="mb-5">
        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">Onboarding steps</h2>
        <nav id="steps-nav" class="space-y-1 text-sm">
          <button data-step="intro"      class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>1. Introduction</span>
          </button>
          <button data-step="branded"    class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>2. Branded Tracking</span>
          </button>
          <button data-step="feed"       class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>3. Product Feed</span>
          </button>
          <button data-step="assets"     class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>4. Program Assets</span>
          </button>
          <button data-step="ip"         class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>5. IP Addresses</span>
          </button>
          <button data-step="scripts"    class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-800">
            <span>6. Tracking Scripts</span>
          </button>
        </nav>
      </div>

      <!-- Progress -->
      <div class="mb-5">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Overall Progress</span>
          <span id="progress-percentage" class="text-xs font-semibold text-td-blue">0%</span>
        </div>
        <div class="w-full h-1.5 rounded-full bg-gray-200 dark:bg-gray-800 overflow-hidden">
          <div id="progress-bar" class="h-1.5 rounded-full bg-td-blue transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- Summary -->
      <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-800">
        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Collected Data</h3>
        <div id="data-summary" class="text-xs text-gray-600 dark:text-gray-300 space-y-0.5">
          <p>No data collected yet</p>
        </div>

        <button
          onclick="resetOnboarding()"
          class="mt-3 w-full px-3 py-1.5 rounded-lg border border-red-200 dark:border-red-600 text-[11px] text-red-600 hover:bg-red-50 dark:hover:bg-red-900/40">
          Reset onboarding
        </button>
      </div>
    </aside>

    <!-- Main area -->
    <main class="flex-1 flex flex-col">
      <!-- Step header -->
      <div class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] px-6 py-3 flex items-center justify-between">
        <div>
          <h2 id="step-title" class="text-sm font-semibold text-gray-900 dark:text-gray-100">Introduction</h2>
          <p id="step-subtitle" class="text-xs text-gray-500 dark:text-gray-400">
            Tell me who you are and which company you represent.
          </p>
        </div>
      </div>

      <!-- Step content: each step has its own chat container -->
      <div class="flex-1 overflow-hidden">
        <!-- INTRO -->
        <section id="step-intro" class="step-page h-full flex flex-col">
          <div id="chat-intro" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-intro" type="text" placeholder="Type your message..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-intro" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- BRANDED TRACKING -->
        <section id="step-branded" class="step-page h-full flex flex-col hidden">
          <div id="chat-branded" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-branded" type="text" placeholder="Share your branded tracking domains..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-branded" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- PRODUCT FEED -->
        <section id="step-feed" class="step-page h-full flex flex-col hidden">
          <div id="chat-feed" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-feed" type="text" placeholder="Paste your product feed URL..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-feed" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- ASSETS -->
        <section id="step-assets" class="step-page h-full flex flex-col hidden">
          <div id="chat-assets" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-assets" type="text" placeholder="Tell me what assets you're uploading..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-assets" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- IP ADDRESSES -->
        <section id="step-ip" class="step-page h-full flex flex-col hidden">
          <div id="chat-ip" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-ip" type="text" placeholder="Share the IP addresses to exclude..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-ip" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>

        <!-- TRACKING SCRIPTS -->
        <section id="step-scripts" class="step-page h-full flex flex-col hidden">
          <div id="chat-scripts" class="flex-1 overflow-y-auto p-6 space-y-3"></div>
          <div class="border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#020617] p-3">
            <div class="max-w-3xl mx-auto flex gap-2">
              <input id="input-scripts" type="text" placeholder="Ask about implementing your tracking scripts..."
                     class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-td-blue" />
              <button id="send-scripts" class="px-4 py-2 bg-td-blue text-white text-sm rounded-xl hover:bg-td-blue-dark transition shadow-brand">
                Send
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== CONFIG =====
    const N8N_WEBHOOK_URL = 'https://harrytradedoubler2026.app.n8n.cloud/webhook/onboarding-chat';
    const STEPS = ['intro', 'branded', 'feed', 'assets', 'ip', 'scripts'];

    const stepMeta = {
      intro:   { title: 'Introduction',      subtitle: 'Tell me who you are and which company you represent.' },
      branded: { title: 'Branded Tracking', subtitle: 'Weâ€™ll configure your visit.* and statics.* tracking domains.' },
      feed:    { title: 'Product Feed',     subtitle: 'Share your product feed URL and format so we can map it.' },
      assets:  { title: 'Program Assets',   subtitle: 'Upload your logo, banners and program documents.' },
      ip:      { title: 'IP Addresses',     subtitle: 'Provide office IPs to exclude internal traffic from tracking.' },
      scripts: { title: 'Tracking Scripts', subtitle: 'Weâ€™ll walk through integrating your Tradedoubler tracking tags.' },
    };

    // ===== GLOBAL STATE =====
    let currentStep = 'intro';
    let sessionId = generateSessionId();
    let histories = {};  // { step: [{role, content}, ...] }
    let onboardingData = {};
    let checklist = {
      intro: false,
      brandedTracking: false,
      productFeed: false,
      assets: false,
      ipAddresses: false,
      trackingScripts: false,
    };

    // ===== DOM =====
    const stepTitle = document.getElementById('step-title');
    const stepSubtitle = document.getElementById('step-subtitle');
    const navButtons = document.querySelectorAll('.step-nav-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressPct = document.getElementById('progress-percentage');
    const dataSummary = document.getElementById('data-summary');

    // ===== DARK MODE =====
    function loadDarkMode() {
      if (localStorage.getItem('td_dark_mode') === '1') {
        document.documentElement.classList.add('dark');
      }
    }
    function toggleDarkMode() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('td_dark_mode', isDark ? '1' : '0');
    }
    loadDarkMode();

    // ===== STORAGE HELPERS =====
    function saveState() {
      localStorage.setItem('td_step', currentStep);
      localStorage.setItem('td_histories', JSON.stringify(histories));
      localStorage.setItem('td_onboarding_data', JSON.stringify(onboardingData));
      localStorage.setItem('td_checklist', JSON.stringify(checklist));
    }
    function loadState() {
      const s = localStorage.getItem('td_step');
      const h = localStorage.getItem('td_histories');
      const d = localStorage.getItem('td_onboarding_data');
      const c = localStorage.getItem('td_checklist');

      if (s && STEPS.includes(s)) currentStep = s;
      histories = h ? JSON.parse(h) : {};
      onboardingData = d ? JSON.parse(d) : {};
      checklist = c ? JSON.parse(c) : checklist;
    }

    function resetOnboarding() {
      localStorage.removeItem('td_step');
      localStorage.removeItem('td_histories');
      localStorage.removeItem('td_onboarding_data');
      localStorage.removeItem('td_checklist');
      location.reload();
    }

    // ===== INIT =====
    loadState();

    // ensure histories object has arrays per step
    STEPS.forEach(step => {
      if (!Array.isArray(histories[step])) histories[step] = [];
    });

    // default intro greeting if first time
    if (histories.intro.length === 0) {
      histories.intro.push({
        role: 'assistant',
        content:
          "Hi! ðŸ‘‹ I'm your Tradedoubler onboarding assistant.\n\nWe'll go through your setup step by step.\n\nLetâ€™s start with a quick introduction. What's your name and company?",
      });
    }

    // Wire inputs/send buttons per step
    STEPS.forEach(step => {
      const input = document.getElementById('input-' + step);
      const sendBtn = document.getElementById('send-' + step);
      if (!input || !sendBtn) return;

      sendBtn.addEventListener('click', () => sendMessage(step));
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(step);
        }
      });
    });

    // Sidebar nav clicks
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const step = btn.getAttribute('data-step');
        goToStep(step);
      });
    });

    // Initial render
    goToStep(currentStep);
    updateChecklistUI();
    updateDataSummary();

    // ===== CORE FUNCTIONS =====
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
    }

    function goToStep(step) {
      if (!STEPS.includes(step)) step = 'intro';
      currentStep = step;

      // hide all step sections
      document.querySelectorAll('.step-page').forEach(s => s.classList.add('hidden'));
      document.getElementById('step-' + step).classList.remove('hidden');

      // update header
      stepTitle.textContent = stepMeta[step].title;
      stepSubtitle.textContent = stepMeta[step].subtitle;

      // update nav highlighting
      navButtons.forEach(btn => {
        const s = btn.getAttribute('data-step');
        if (s === step) {
          btn.classList.add('bg-td-blue', 'text-white', 'shadow-brand');
        } else {
          btn.classList.remove('bg-td-blue', 'text-white', 'shadow-brand');
        }
      });

      // render that step's history
      const chatEl = document.getElementById('chat-' + step);
      chatEl.innerHTML = '';
      histories[step].forEach(msg => addMessageToChat(step, msg.role, msg.content));

      saveState();
    }

    async function sendMessage(step) {
      const input = document.getElementById('input-' + step);
      const chatEl = document.getElementById('chat-' + step);
      if (!input || !chatEl) return;

      const text = input.value.trim();
      if (!text) return;

      // append user message
      histories[step].push({ role: 'user', content: text });
      addMessageToChat(step, 'user', text);
      input.value = '';

      const loadingId = addLoadingIndicator(step);

      try {
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            step,
            message: text,
            conversationHistory: histories[step],
            onboardingData,
            checklist,
          }),
        });

        const data = await response.json();
        removeLoadingIndicator(loadingId);

        histories[step].push({ role: 'assistant', content: data.response });
        addMessageToChat(step, 'assistant', data.response);

        if (data.onboardingData) onboardingData = data.onboardingData;
        if (data.checklist) checklist = data.checklist;

        updateChecklistUI();
        updateDataSummary();
        saveState();
      } catch (err) {
        console.error(err);
        removeLoadingIndicator(loadingId);
        histories[step].push({
          role: 'assistant',
          content: 'I ran into an issue responding just now. Please try again in a moment.',
        });
        addMessageToChat(step, 'assistant', 'I ran into an issue responding just now. Please try again in a moment.');
      }
    }

    function addMessageToChat(step, role, content) {
      const chatEl = document.getElementById('chat-' + step);
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className =
        'max-w-2xl px-3 py-2 rounded-brand text-sm chat-message ' +
        (role === 'user'
          ? 'bg-td-blue text-white shadow-brand'
          : 'bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 border border-gray-200 dark:border-gray-700 shadow-sm');

      bubble.innerHTML = content
        .split('\n')
        .map((line) => {
          if (!line.trim()) return '<p class="mb-1">&nbsp;</p>';
          if (line.startsWith('â€¢') || line.startsWith('-')) return `<p class="ml-4">${line}</p>`;
          return `<p class="mb-1">${line}</p>`;
        })
        .join('');

      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addLoadingIndicator(step) {
      const chatEl = document.getElementById('chat-' + step);
      const id = `loading_${step}_${Date.now()}`;
      const wrapper = document.createElement('div');
      wrapper.id = id;
      wrapper.className = 'flex justify-start';

      wrapper.innerHTML = `
        <div class="px-3 py-2 rounded-brand bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
          <div class="flex gap-1">
            <div class="w-2 h-2 rounded-full bg-td-blue pulse-loader"></div>
            <div class="w-2 h-2 rounded-full bg-td-blue pulse-loader" style="animation-delay:0.15s"></div>
            <div class="w-2 h-2 rounded-full bg-td-blue pulse-loader" style="animation-delay:0.3s"></div>
          </div>
        </div>
      `;
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
      return id;
    }

    function removeLoadingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function updateChecklistUI() {
      const doneCount = Object.values(checklist).filter(Boolean).length;
      const total = Object.keys(checklist).length;
      const pct = Math.round((doneCount / total) * 100);
      progressPct.textContent = `${pct}%`;
      progressBar.style.width = `${pct}%`;
    }

    function updateDataSummary() {
      const parts = [];
      if (onboardingData.clientName) parts.push(`<p><strong>Client:</strong> ${onboardingData.clientName}</p>`);
      if (onboardingData.companyName) parts.push(`<p><strong>Company:</strong> ${onboardingData.companyName}</p>`);
      if (onboardingData.email) parts.push(`<p><strong>Email:</strong> ${onboardingData.email}</p>`);
      if (onboardingData.brandedTracking?.visit)
        parts.push(`<p><strong>Visit:</strong> ${onboardingData.brandedTracking.visit}</p>`);
      if (onboardingData.brandedTracking?.statics)
        parts.push(`<p><strong>Statics:</strong> ${onboardingData.brandedTracking.statics}</p>`);
      if (onboardingData.productFeedUrl)
        parts.push(`<p><strong>Feed URL:</strong> ${onboardingData.productFeedUrl}</p>`);
      if (onboardingData.officeIPs?.length)
        parts.push(`<p><strong>IPs:</strong> ${onboardingData.officeIPs.length} address(es)</p>`);

      dataSummary.innerHTML = parts.length ? parts.join('') : '<p>No data collected yet</p>';
    }
  </script>
</body>
</html>
