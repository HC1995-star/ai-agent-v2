<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradedoubler Onboarding Assistant</title>

  <!-- Brand font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Instrument Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .chat-message {
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .pulse-loader {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.4; }
    }
    .step-marker {
      scroll-margin-top: 20px;
    }
    .upload-panel {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .upload-panel.hidden {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-white text-gray-900 h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-gray-200 p-5 flex flex-col sticky top-0 h-screen overflow-y-auto">
      <div class="flex items-center justify-between mb-5">
        <div>
          <h1 class="text-xl font-semibold text-[#2A73FF]">Tradedoubler</h1>
          <p class="text-xs text-gray-500">AI Onboarding Assistant</p>
        </div>
      </div>

      <!-- Steps nav -->
      <div class="mb-5">
        <h2 class="text-xs font-semibold text-gray-500 mb-2">
          Onboarding steps
        </h2>
        <nav id="steps-nav" class="space-y-1 text-sm">
          <button data-step="intro" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>1. Introduction</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="branded" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>2. Branded Tracking</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="feed" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>3. Product Feed</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="assets" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>4. Program Assets</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="ip" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>5. IP Addresses</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
          <button data-step="scripts" class="step-nav-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-left hover:bg-gray-100">
            <span>6. Tracking Scripts</span>
            <span class="step-check hidden text-green-500">✓</span>
          </button>
        </nav>
      </div>

      <!-- Progress -->
      <div class="mb-5">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-medium text-gray-600">Overall Progress</span>
          <span id="progress-percentage" class="text-xs font-semibold text-[#2A73FF]">0%</span>
        </div>
        <div class="w-full h-1.5 rounded-full bg-gray-200 overflow-hidden">
          <div id="progress-bar" class="h-1.5 rounded-full bg-[#2A73FF] transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- Upload Assets Button -->
      <button
        id="toggle-upload-panel"
        class="mb-4 w-full px-3 py-2 bg-[#F7F9FF] border border-[#2A73FF]/30 text-[#2A73FF] rounded-lg text-sm font-medium hover:bg-[#2A73FF]/10 transition flex items-center justify-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Upload Assets
      </button>

      <!-- Summary -->
      <div class="mt-auto pt-4 border-t border-gray-200">
        <h3 class="text-xs font-semibold text-gray-500 mb-1">Collected Data</h3>
        <div id="data-summary" class="text-xs text-gray-600 space-y-0.5">
          <p>No data collected yet</p>
        </div>

        <button
          onclick="resetOnboarding()"
          class="mt-3 w-full px-3 py-1.5 rounded-lg border border-red-200 text-[11px] text-red-600 hover:bg-red-50"
        >
          Reset onboarding
        </button>
      </div>
    </aside>

    <!-- Main area -->
    <main class="flex-1 flex flex-col bg-white h-full overflow-hidden relative">
      <!-- Single Chat Container -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-3 pb-3"></div>

      <!-- GLOBAL INPUT BAR -->
      <div class="shrink-0 bg-white border-t border-gray-200 p-3">
        <div class="max-w-[1100px] w-full mx-auto flex gap-2">
          <input
            id="global-input"
            type="text"
            placeholder="Type your message..."
            class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-xl bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#2A73FF] focus:border-transparent"
          />
          <button
            id="global-send"
            class="px-4 py-2 bg-[#2A73FF] text-white text-sm rounded-xl hover:bg-[#1F5ED8] transition shadow-md"
          >
            Send
          </button>
        </div>
      </div>

      <!-- Upload Panel (Slide-out) -->
      <div id="upload-panel" class="upload-panel hidden fixed top-0 right-0 w-96 h-full bg-white border-l border-gray-200 shadow-xl z-50 overflow-y-auto">
        <div class="p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Upload Assets</h3>
            <button id="close-upload-panel" class="text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <!-- Logo -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700">Logo</h4>
                <span class="text-xs text-gray-500">350×130px</span>
              </div>
              <button onclick="document.getElementById('logo-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                Upload Logo
              </button>
              <input type="file" id="logo-input" accept=".png,.jpg,.jpeg" class="hidden" />
              <div id="logo-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Banners -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700">Banners</h4>
                <span class="text-xs text-gray-500">Multiple sizes</span>
              </div>
              <p class="text-xs text-gray-500 mb-2">160×600, 300×250, 300×600, 728×90, 928×70</p>
              <button onclick="document.getElementById('banners-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                Upload Banners
              </button>
              <input type="file" id="banners-input" accept=".jpg,.jpeg,.gif,.png" multiple class="hidden" />
              <div id="banners-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Terms & Conditions -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700">Terms & Conditions</h4>
                <span class="text-xs text-gray-500">PDF</span>
              </div>
              <button onclick="document.getElementById('terms-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                Upload T&Cs
              </button>
              <input type="file" id="terms-input" accept=".pdf" class="hidden" />
              <div id="terms-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Other Documents -->
            <div class="bg-[#F7F9FF] rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-xs font-medium text-gray-700">Other Documents</h4>
                <span class="text-xs text-gray-500">Optional</span>
              </div>
              <button onclick="document.getElementById('other-input').click()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-xs">
                Upload Files
              </button>
              <input type="file" id="other-input" multiple class="hidden" />
              <div id="other-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Send all -->
            <button
              id="send-all-files"
              class="w-full mt-1 px-4 py-2.5 bg-[#2A73FF] text-white rounded-lg hover:bg-[#1F5ED8] transition-colors text-sm font-medium shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed"
              disabled
            >
              Send All Files
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // CONFIG
    const N8N_WEBHOOK_URL = 'https://coe-n8n.common-eu-de.services.tddrift.net/webhook/onboarding-chat';
    const STEPS = ['intro', 'branded', 'feed', 'assets', 'ip', 'scripts'];

    const stepMeta = {
      intro: { title: 'Introduction', subtitle: 'Tell me who you are and which company you represent.' },
      branded: { title: 'Branded Tracking', subtitle: 'Configure your visit.* and statics.* tracking domains.' },
      feed: { title: 'Product Feed', subtitle: 'Share your product feed URL and format.' },
      assets: { title: 'Program Assets', subtitle: 'Upload your logo, banners, T&Cs and documents.' },
      ip: { title: 'IP Addresses', subtitle: 'Provide office IPs to exclude from tracking.' },
      scripts: { title: 'Tracking Scripts', subtitle: 'Integrate your Tradedoubler tracking tags.' },
    };

    const checklistMap = {
      intro: 'intro',
      branded: 'brandedTracking',
      feed: 'productFeed',
      assets: 'assets',
      ip: 'ipAddresses',
      scripts: 'trackingScripts'
    };

    // STATE - Single conversation history
    let sessionId = generateSessionId();
    let conversationHistory = []; // Array of {role, content, step, timestamp}
    let currentStep = 'intro';
    let onboardingData = {};
    let checklist = { intro: false, brandedTracking: false, productFeed: false, assets: false, ipAddresses: false, trackingScripts: false };
    let uploadedFiles = { logo: [], banners: [], terms: [], other: [] };

    // DOM
    const chatContainer = document.getElementById('chat-container');
    const navButtons = document.querySelectorAll('.step-nav-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressPct = document.getElementById('progress-percentage');
    const dataSummary = document.getElementById('data-summary');
    const sendAllFilesBtn = document.getElementById('send-all-files');
    const logoInput = document.getElementById('logo-input');
    const bannersInput = document.getElementById('banners-input');
    const termsInput = document.getElementById('terms-input');
    const otherInput = document.getElementById('other-input');
    const globalInput = document.getElementById('global-input');
    const globalSend = document.getElementById('global-send');
    const uploadPanel = document.getElementById('upload-panel');
    const toggleUploadBtn = document.getElementById('toggle-upload-panel');
    const closeUploadBtn = document.getElementById('close-upload-panel');

    // STORAGE
    function saveState() {
      localStorage.setItem('td_v2_session', sessionId);
      localStorage.setItem('td_v2_history', JSON.stringify(conversationHistory));
      localStorage.setItem('td_v2_step', currentStep);
      localStorage.setItem('td_v2_data', JSON.stringify(onboardingData));
      localStorage.setItem('td_v2_checklist', JSON.stringify(checklist));
      localStorage.setItem('td_v2_files', JSON.stringify(uploadedFiles));
    }

    function loadState() {
      const s = localStorage.getItem('td_v2_session');
      const h = localStorage.getItem('td_v2_history');
      const st = localStorage.getItem('td_v2_step');
      const d = localStorage.getItem('td_v2_data');
      const c = localStorage.getItem('td_v2_checklist');
      const f = localStorage.getItem('td_v2_files');

      if (s) sessionId = s;
      if (h) conversationHistory = JSON.parse(h);
      if (st && STEPS.includes(st)) currentStep = st;
      if (d) onboardingData = JSON.parse(d);
      if (c) checklist = JSON.parse(c);
      if (f) uploadedFiles = JSON.parse(f);
    }

    function resetOnboarding() {
      localStorage.removeItem('td_v2_session');
      localStorage.removeItem('td_v2_history');
      localStorage.removeItem('td_v2_step');
      localStorage.removeItem('td_v2_data');
      localStorage.removeItem('td_v2_checklist');
      localStorage.removeItem('td_v2_files');
      location.reload();
    }

    // INIT
    loadState();

    // Add welcome message if new session
    if (conversationHistory.length === 0) {
      conversationHistory.push({
        role: 'assistant',
        content: "Hi! I'm your Tradedoubler onboarding assistant.\n\nI'll walk you through your technical setup step-by-step.\n\nWhat you'll need from you:\n\n• Website domain\n\n• Product feed URL\n\n• Office IP addresses\n\n• Company logos & banners\n\nWhat requires your technical team:\n\n• DNS/CNAME setup (I'll provide exact records)\n\n• Tracking script integration (I'll provide the code)\n\n• Test transaction (I'll provide test link)\n\nDon't have everything ready? That's fine! We can pause at any step and you can provide information later. I'll make a note of what's pending.\n\nNeed to understand something better? Just ask!\n\nLet's get started! What's your name, company, and email address?",
        step: 'intro',
        timestamp: Date.now()
      });
      saveState();
    }

    // Render conversation
    normalizeConversationSteps();
    renderConversation();
    updateChecklistUI();
    updateDataSummary();
    updateFileLists();
    updateSendAllButton();
    highlightCurrentStep();

    // Event listeners
    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const step = btn.getAttribute('data-step');
        scrollToStep(step);
      });
    });

    globalSend.addEventListener('click', () => sendMessage());
    globalInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    logoInput.addEventListener('change', (e) => handleFileUpload(e, 'logo', 'logo-list'));
    bannersInput.addEventListener('change', (e) => handleFileUpload(e, 'banners', 'banners-list'));
    termsInput.addEventListener('change', (e) => handleFileUpload(e, 'terms', 'terms-list'));
    otherInput.addEventListener('change', (e) => handleFileUpload(e, 'other', 'other-list'));
    sendAllFilesBtn.addEventListener('click', sendAllFiles);

    toggleUploadBtn.addEventListener('click', () => {
      uploadPanel.classList.remove('hidden');
    });
    closeUploadBtn.addEventListener('click', () => {
      uploadPanel.classList.add('hidden');
    });

    // CORE FUNCTIONS
    function escapeRegExp(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function inferStepFromText(text) {
      if (!text) return null;
      const lower = text.toLowerCase();

      if (
        lower.includes("i'll walk you through") ||
        lower.includes("what you'll need from you") ||
        lower.includes("let's get started") ||
        lower.includes("what requires your technical team")
      ) {
        return 'intro';
      }

      const stepKeywords = {
        intro: ['name', 'company', 'email'],
        branded: ['branded tracking', 'cname', 'subdomain', 'dns', 'visit.', 'statics.', 'branded'],
        feed: ['product feed', 'feed url', 'feed', 'catalog'],
        assets: ['upload', 'logo', 'banner', 'asset', 't&c', 'terms', 'document'],
        ip: ['ip address', 'ip addresses', 'office ip', 'whitelist', 'exclude ip'],
        scripts: ['tracking script', 'tracking code', 'tag', 'pixel', 'script'],
      };

      const priority = ['feed', 'assets', 'scripts', 'ip', 'branded', 'intro'];
      let bestStep = null;
      let bestScore = 0;

      Object.entries(stepKeywords).forEach(([step, keywords]) => {
        let score = 0;
        keywords.forEach((keyword) => {
          if (keyword.includes(' ') || keyword.includes('.')) {
            if (lower.includes(keyword)) score += 1;
            return;
          }
          const pattern = new RegExp(`\\b${escapeRegExp(keyword)}\\b`, 'i');
          if (pattern.test(lower)) score += 1;
        });

        if (score > bestScore) {
          bestScore = score;
          bestStep = step;
        } else if (score > 0 && score === bestScore) {
          if (priority.indexOf(step) < priority.indexOf(bestStep)) {
            bestStep = step;
          }
        }
      });

      return bestScore > 0 ? bestStep : null;
    }

    function normalizeConversationSteps() {
      let updated = false;
      let stepCursor = currentStep || 'intro';

      conversationHistory.forEach((msg) => {
        if (msg.role === 'assistant') {
          const inferred = inferStepFromText(msg.content);
          if (inferred) stepCursor = inferred;
        }
        if (msg.step !== stepCursor) {
          msg.step = stepCursor;
          updated = true;
        }
      });

      if (stepCursor && stepCursor !== currentStep) currentStep = stepCursor;
      if (updated) saveState();
    }

    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
    }

    function renderConversation() {
      chatContainer.innerHTML = '';
      let lastStep = null;

      conversationHistory.forEach((msg, index) => {
        // Add step marker if step changed
        if (msg.step && msg.step !== lastStep) {
          addStepMarker(msg.step);
          lastStep = msg.step;
        }
        addMessageToDOM(msg.role, msg.content, msg.step, false);
      });

      // Scroll to bottom
      scrollToBottom();
    }

    function addStepMarker(step) {
      const meta = stepMeta[step];
      if (!meta) return;

      const marker = document.createElement('div');
      marker.id = `step-marker-${step}`;
      marker.className = 'step-marker flex items-center gap-3 py-4 my-2';
      marker.innerHTML = `
        <div class="flex-1 h-px bg-gray-200"></div>
        <div class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full">
          <span class="text-xs font-medium text-gray-600">${meta.title}</span>
        </div>
        <div class="flex-1 h-px bg-gray-200"></div>
      `;
      chatContainer.appendChild(marker);
    }

    function addMessageToDOM(role, content, step, animate = true) {
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
      if (step) wrapper.setAttribute('data-step', step);

      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex flex-col ' + (role === 'user' ? 'items-end' : 'items-start');

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'max-w-2xl px-3 py-2 rounded-[14px] text-sm bg-gray-100 text-gray-900 shadow-md' + (animate ? ' chat-message' : '')
        : 'max-w-2xl px-3 py-2 rounded-[14px] text-sm bg-[#2A73FF] text-white shadow-md' + (animate ? ' chat-message' : '');

      bubble.innerHTML = content.split('\n').map((line) => {
        if (!line.trim()) return '<p class="mb-1">&nbsp;</p>';
        if (line.startsWith('•') || line.startsWith('-')) return `<p class="ml-4">${line}</p>`;
        return `<p class="mb-1">${line}</p>`;
      }).join('');

      const timestamp = document.createElement('div');
      timestamp.className = 'text-xs text-gray-400 mt-1 px-1';
      timestamp.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

      inner.appendChild(bubble);
      inner.appendChild(timestamp);
      wrapper.appendChild(inner);
      chatContainer.appendChild(wrapper);
    }

    function scrollToStep(step) {
      const marker = document.getElementById(`step-marker-${step}`);
      if (marker) {
        marker.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        // No messages for this step yet - scroll to bottom and set as current
        currentStep = step;
        highlightCurrentStep();
        scrollToBottom();
      }
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 150);
      });
    }

    function highlightCurrentStep() {
      navButtons.forEach((btn) => {
        const s = btn.getAttribute('data-step');
        if (s === currentStep) {
          btn.classList.add('bg-[#2A73FF]', 'text-white', 'shadow-md');
        } else {
          btn.classList.remove('bg-[#2A73FF]', 'text-white', 'shadow-md');
        }
      });
    }

    async function sendMessage() {
      const text = globalInput.value.trim();
      if (!text) return;

      // Check if we need to add a step marker
      const lastMsg = conversationHistory[conversationHistory.length - 1];
      const needsMarker = !lastMsg || lastMsg.step !== currentStep;

      // Add user message
      const userMsg = { role: 'user', content: text, step: currentStep, timestamp: Date.now() };
      conversationHistory.push(userMsg);

      if (needsMarker) {
        addStepMarker(currentStep);
      }
      addMessageToDOM('user', text, currentStep, true);
      globalInput.value = '';
      highlightCurrentStep();
      scrollToBottom();
      saveState();

      // Show loading
      const loadingId = addLoadingIndicator();

      try {
        // Build trimmed history for API (last 12 messages)
        const trimmedHistory = conversationHistory.slice(-12).map(m => ({ role: m.role, content: m.content }));

        const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
        const lower = text.toLowerCase();
        const filesPayload = totalFiles > 0 && lower.includes('upload') ? uploadedFiles : {};

        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            step: currentStep,
            message: text,
            conversationHistory: trimmedHistory,
            onboardingData,
            checklist,
            uploadedFiles: filesPayload,
          }),
        });

        const data = await response.json();
        removeLoadingIndicator(loadingId);

        // Add assistant response
        let responseStep = currentStep;
        if (data.triggerGoToStep && STEPS.includes(data.triggerGoToStep)) {
          responseStep = data.triggerGoToStep;
        } else {
          const inferredAssistantStep = inferStepFromText(data.response);
          if (inferredAssistantStep) responseStep = inferredAssistantStep;
        }

        const assistantMsg = { role: 'assistant', content: data.response, step: responseStep, timestamp: Date.now() };
        conversationHistory.push(assistantMsg);
        addMessageToDOM('assistant', data.response, responseStep, true);

        // Update state from response
        if (data.onboardingData) onboardingData = data.onboardingData;
        if (data.checklist) checklist = data.checklist;

        // If backend suggests a step change or we inferred one
        if (responseStep && STEPS.includes(responseStep)) {
          currentStep = responseStep;
          highlightCurrentStep();
        }

        updateChecklistUI();
        updateDataSummary();
        scrollToBottom();
        saveState();
      } catch (err) {
        console.error(err);
        removeLoadingIndicator(loadingId);
        const errorMsg = { role: 'assistant', content: 'I ran into an issue responding just now. Please try again in a moment.', step: currentStep, timestamp: Date.now() };
        conversationHistory.push(errorMsg);
        addMessageToDOM('assistant', errorMsg.content, currentStep, true);
      }
    }

    function addLoadingIndicator() {
      const id = `loading_${Date.now()}`;
      const wrapper = document.createElement('div');
      wrapper.id = id;
      wrapper.className = 'flex justify-start';
      const inner = document.createElement('div');
      inner.className = 'max-w-[1100px] w-full flex justify-start';
      inner.innerHTML = `<div class="px-3 py-2 rounded-[14px] bg-white border border-gray-200"><div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader"></div><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.15s"></div><div class="w-2 h-2 rounded-full bg-[#2A73FF] pulse-loader" style="animation-delay:0.3s"></div></div></div>`;
      wrapper.appendChild(inner);
      chatContainer.appendChild(wrapper);
      scrollToBottom();
      return id;
    }

    function removeLoadingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function updateChecklistUI() {
      const doneCount = Object.values(checklist).filter(Boolean).length;
      const total = Object.keys(checklist).length;
      const pct = Math.round((doneCount / total) * 100);
      progressPct.textContent = `${pct}%`;
      progressBar.style.width = `${pct}%`;

      // Update checkmarks on nav buttons
      navButtons.forEach((btn) => {
        const step = btn.getAttribute('data-step');
        const checkKey = checklistMap[step];
        const checkEl = btn.querySelector('.step-check');
        if (checkEl && checklist[checkKey]) {
          checkEl.classList.remove('hidden');
        } else if (checkEl) {
          checkEl.classList.add('hidden');
        }
      });
    }

    function updateDataSummary() {
      const parts = [];
      if (onboardingData.clientName) parts.push(`<p><strong>Client:</strong> ${onboardingData.clientName}</p>`);
      if (onboardingData.companyName) parts.push(`<p><strong>Company:</strong> ${onboardingData.companyName}</p>`);
      if (onboardingData.email) parts.push(`<p><strong>Email:</strong> ${onboardingData.email}</p>`);
      if (onboardingData.brandedTracking?.visit) parts.push(`<p><strong>Visit:</strong> ${onboardingData.brandedTracking.visit}</p>`);
      if (onboardingData.brandedTracking?.statics) parts.push(`<p><strong>Statics:</strong> ${onboardingData.brandedTracking.statics}</p>`);
      if (onboardingData.productFeedUrl) parts.push(`<p><strong>Feed URL:</strong> ${onboardingData.productFeedUrl}</p>`);
      if (onboardingData.officeIPs?.length) parts.push(`<p><strong>IPs:</strong> ${onboardingData.officeIPs.length} address(es)</p>`);
      dataSummary.innerHTML = parts.length > 0 ? parts.join('') : '<p>No data collected yet</p>';
    }

    function handleFileUpload(event, category, listId) {
      const files = Array.from(event.target.files);
      if (!files.length) return;
      const listElement = document.getElementById(listId);
      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles[category].push({ name: file.name, type: file.type, size: file.size, data: e.target.result.split(',')[1], category });
          const fileDiv = document.createElement('div');
          fileDiv.className = 'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `<svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg><span class="flex-1 truncate text-xs">${file.name}</span><button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>`;
          listElement.appendChild(fileDiv);
          updateSendAllButton();
          saveState();
        };
        reader.readAsDataURL(file);
      });
      event.target.value = '';
    }

    function removeFile(category, fileName) {
      uploadedFiles[category] = uploadedFiles[category].filter((f) => f.name !== fileName);
      updateFileLists();
      updateSendAllButton();
      saveState();
    }

    function updateFileLists() {
      const lists = { logo: 'logo-list', banners: 'banners-list', terms: 'terms-list', other: 'other-list' };
      Object.keys(lists).forEach((category) => {
        const listElement = document.getElementById(lists[category]);
        if (!listElement) return;
        listElement.innerHTML = '';
        (uploadedFiles[category] || []).forEach((file) => {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'text-xs text-gray-700 flex items-center gap-2 p-1.5 bg-white rounded border border-gray-200';
          fileDiv.innerHTML = `<svg class="w-3 h-3 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg><span class="flex-1 truncate text-xs">${file.name}</span><button onclick="removeFile('${category}', '${file.name}')" class="text-red-500 hover:text-red-700"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>`;
          listElement.appendChild(fileDiv);
        });
      });
    }

    function updateSendAllButton() {
      const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
      sendAllFilesBtn.disabled = totalFiles === 0;
      sendAllFilesBtn.textContent = totalFiles > 0 ? `Send All Files (${totalFiles})` : 'Send All Files';
    }

    async function sendAllFiles() {
      const totalFiles = Object.values(uploadedFiles).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
      if (totalFiles === 0) return;
      const filesSummary = Object.entries(uploadedFiles).filter(([_, files]) => files && files.length > 0).map(([category, files]) => `${category}: ${files.length} file(s)`).join(', ');
      globalInput.value = `I'm uploading ${totalFiles} files: ${filesSummary}`;
      uploadPanel.classList.add('hidden');
      await sendMessage();
    }
  </script>
</body>
</html>
